name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'wecom-webhook/**'
      - '.github/workflows/build-docker-image.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'wecom-webhook/**'
  schedule:
    # æ¯å¤© UTC 0:00 å’Œ 12:00 è¿è¡Œ
    # åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰å¯¹åº”ï¼šUTC 16:00ï¼ˆåŒ—äº¬æ—¶é—´ 0:00ï¼‰å’Œ UTC 4:00ï¼ˆåŒ—äº¬æ—¶é—´ 12:00ï¼‰
    # å¦‚éœ€è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´ï¼Œè¯·ä½¿ç”¨ï¼š'0 16 * * *' å’Œ '0 4 * * *'
  - cron: '0 16 * * *'   # UTC 16:00 = åŒ—äº¬æ—¶é—´ 0:00ï¼ˆç¬¬äºŒå¤©ï¼‰
  - cron: '0 4 * * *'    # UTC 4:00 = åŒ—äº¬æ—¶é—´ 12:00
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'

env:
  IMAGE_NAME: wecom-webhook-server

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Huawei SWR
        uses: docker/login-action@v3
        with:
          registry: swr.${{ secrets.HUAWEI_SWR_REGION }}.myhuaweicloud.com
          username: ${{ secrets.HUAWEI_SWR_DOCKER_USERNAME }}
          password: ${{ secrets.HUAWEI_SWR_DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        run: |
          # ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            # ä½¿ç”¨ commit SHA çš„å‰ 7 ä½ä½œä¸ºæ ‡ç­¾
            TAG="${GITHUB_SHA::7}"
          fi
          
          # è®¾ç½®é•œåƒå®Œæ•´è·¯å¾„
          IMAGE_FULL_NAME="swr.${{ secrets.HUAWEI_SWR_REGION }}.myhuaweicloud.com/${{ secrets.HUAWEI_SWR_NAMESPACE }}/${IMAGE_NAME}"
          
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE_FULL_NAME}" >> $GITHUB_OUTPUT
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºä¿¡æ¯
          echo "Building image: ${IMAGE_FULL_NAME}:${TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./wecom-webhook
          file: ./wecom-webhook/Dockerfile
          push: true
          platforms: linux/amd64
          provenance: false
          sbom: false
          tags: |
            ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Set repository to public
        run: |
          # å®‰è£…åä¸ºäº‘ SDK
          pip install huaweicloudsdkcore huaweicloudsdkswr
          
          # è®¾ç½®é•œåƒä»“åº“ä¸ºå…¬å¼€
          python - <<EOF
          import os
          from huaweicloudsdkcore.auth.credentials import BasicCredentials
          from huaweicloudsdkcore.http.http_config import HttpConfig
          from huaweicloudsdkcore.exceptions import exceptions
          from huaweicloudsdkswr.v2 import SWRClient, UpdateRepoRequest, UpdateRepoRequestBody
          from huaweicloudsdkswr.v2.region.swr_region import SWRRegion
          
          # é…ç½®
          ak = os.environ.get('HUAWEI_CLOUD_ACCESS_KEY')
          sk = os.environ.get('HUAWEI_CLOUD_SECRET_KEY')
          region = os.environ.get('HUAWEI_SWR_REGION')
          namespace = os.environ.get('HUAWEI_SWR_NAMESPACE')
          repository = '${IMAGE_NAME}'
          
          # åˆ›å»ºå®¢æˆ·ç«¯
          credentials = BasicCredentials(ak, sk)
          client = SWRClient.new_builder() \
              .with_credentials(credentials) \
              .with_region(SWRRegion.value_of(region)) \
              .build()
          
          # è®¾ç½®ä¸ºå…¬å¼€
          try:
              request = UpdateRepoRequest()
              request.namespace = namespace
              request.repository = repository
              request.body = UpdateRepoRequestBody(is_public=True)
              
              response = client.update_repo(request)
              print(f"âœ… æˆåŠŸè®¾ç½®é•œåƒä»“åº“ä¸ºå…¬å¼€: {namespace}/{repository}")
          except exceptions.ClientRequestException as e:
              print(f"âŒ è®¾ç½®å¤±è´¥: {e.error_msg}")
              exit(1)
          EOF
        env:
          HUAWEI_CLOUD_ACCESS_KEY: ${{ secrets.HUAWEI_CLOUD_ACCESS_KEY }}
          HUAWEI_CLOUD_SECRET_KEY: ${{ secrets.HUAWEI_CLOUD_SECRET_KEY }}
          HUAWEI_SWR_REGION: ${{ secrets.HUAWEI_SWR_REGION }}
          HUAWEI_SWR_NAMESPACE: ${{ secrets.HUAWEI_SWR_NAMESPACE }}

      - name: Image build summary
        run: |
          echo "## ğŸ‰ Docker é•œåƒæ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: \`${{ steps.meta.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: \`${{ steps.meta.outputs.tag }}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ SHA**: \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ ä½¿ç”¨æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æˆ–ä½¿ç”¨ latest æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.image }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
